<script src="../../../helpers/error.helper.ts"></script>
<form [formGroup]="form" (ngSubmit)="submit()">
    <div class="flex flex-col card gap-2">
        <div class="flex flex-row gap-2 justify-between">
            <div class="flex flex-col align-middle" *ngIf="getTitle()">
                <div class="font-semibold align-middle text-center">{{ getTitle() }}</div>
            </div>
            <div class="flex flex-col justify-end" *ngIf="shouldShowRefresh">
                <p-button pTooltip="Refresh data" tooltipPosition="top"  icon="pi pi-refresh" severity="secondary" (onClick)="refresh()" />
            </div>
        </div>

        <div class="flex flex-col w-full">
            <p-selectbutton size="small" styleClass="w-full" [options]="transactionTypes"
                            formControlName="type" optionLabel="name"
                            optionValue="value">
                <ng-template #item let-item>
                    <div class="flex flex-col items-center gap-2">
                        <i [class]="item.icon"></i>
                        <label>{{ item.name }}</label>
                    </div>
                </ng-template>
            </p-selectbutton>
        </div>

        <div class="flex gap-2">
            <div class="flex flex-col w-1/2">
                <div class="flex flex-col gap-2">
                    <label for="currency">Source Account *</label>
                    <p-select
                        [options]="getApplicableAccounts(this.form.get('type')?.value,true)"
                        formControlName="sourceAccountId"
                        [filter]="true"
                        filterBy="name"
                        optionLabel="name"
                        optionValue="id"
                        placeholder="Select source account"
                    >
                        <ng-template #item let-account>
                            <div class="flex flex-col text-sm leading-tight py-1 w-full">
                                <div class="font-semibold mb-1 text-center">{{ account.name }}</div>
                                <div class="flex gap-3 text-xs text-gray-600 dark:text-gray-400 justify-center">
                                    <span class="flex-shrink-0">Type: <span class="text-gray-900 dark:text-gray-100">{{ getAccountTypeName(account.type) }}</span></span>
                                    <span class="flex-shrink-0">Currency: <span class="text-gray-900 dark:text-gray-100">{{ account.currency }}</span></span>
                                    <span class="flex-shrink-0">Balance: <span class="font-mono"
                                        [class.text-green-600]="parseFloat(account.currentBalance) > 0"
                                        [class.dark:text-green-400]="parseFloat(account.currentBalance) > 0"
                                        [class.text-red-600]="parseFloat(account.currentBalance) < 0"
                                        [class.dark:text-red-400]="parseFloat(account.currentBalance) < 0">{{ account.currentBalance }}</span></span>
                                </div>
                            </div>
                        </ng-template>
                    </p-select>
                    @if (sourceAccountId.invalid && (sourceAccountId.dirty || sourceAccountId.touched)) {
                        <p-message severity="error" variant="simple" size="small">Source Account is required</p-message>
                    }
                    <div class="flex gap-2">
                        <p-inputgroup>
                            <p-inputnumber formControlName="sourceAmount"
                                           placeholder="Amount *"
                                           mode="decimal"
                                           [minFractionDigits]="2" [maxFractionDigits]="5"
                            ></p-inputnumber>
                            <p-inputgroup-addon
                                [style]="{'color': 'deepskyblue'}">{{ form.get('sourceCurrency')?.value ?? '' }}
                            </p-inputgroup-addon>
                        </p-inputgroup>
                        <p-button [disabled]="!canConvert()" severity="info" label="Convert"
                                  icon="pi pi-arrow-right"
                                  iconPos="left"
                                  (onClick)="convertAmount(this.form.get('sourceAmount')!.value, this.form.get('sourceCurrency')!.value,'destination')"
                        />
                    </div>
                    @if (sourceAmount.invalid && (sourceAmount.dirty || sourceAmount.touched)) {
                        <p-message severity="error" variant="simple" size="small">Source Amount should be > 0</p-message>
                    }
                </div>
            </div>
            <div class="flex flex-col w-1/2" *ngIf="isForeignCurrencyActive()">
                <div class="flex flex-col gap-2">
                    <label for="currency">Foreign Currency (optional)</label>
                    <p-select
                        [options]="currencies"
                        formControlName="fxSourceCurrency"
                        [filter]="true"
                        filterBy="id"
                        optionLabel="id"
                        optionValue="id"
                        placeholder="Select foreign currency" />
                    <div class="flex gap-2">
                        <p-button [disabled]="!canConvert()" severity="info" label="Convert"
                                  icon="pi pi-arrow-left"
                                  iconPos="left"
                                  (onClick)="convertAmount(this.form.get('fxSourceAmount')!.value, this.form.get('fxSourceCurrency')!.value,'source')"
                        />
                        <p-inputgroup>
                            <p-inputnumber formControlName="fxSourceAmount"
                                           mode="decimal"
                                           [minFractionDigits]="2" [maxFractionDigits]="5"
                                           placeholder="Amount"></p-inputnumber>
                            <p-inputgroup-addon
                                [style]="{'color': 'deepskyblue'}">{{ this.form.get('fxSourceCurrency')?.value ?? '' }}
                            </p-inputgroup-addon>
                        </p-inputgroup>
                        <p-button [disabled]="!canConvert()" severity="info" label="Convert"
                                  icon="pi pi-arrow-right"
                                  iconPos="left"
                                  (onClick)="convertAmount(this.form.get('fxSourceAmount')!.value, this.form.get('fxSourceCurrency')!.value,'destination')"
                        />
                    </div>
                </div>
            </div>
            <div class="flex flex-col gap-2 w-1/2">
                <label for="currency">Destination Account *</label>
                <p-select
                    [options]="getApplicableAccounts(this.form.get('type')?.value, false)"
                    formControlName="destinationAccountId"
                    [filter]="true"
                    filterBy="name"
                    optionLabel="name"
                    optionValue="id"
                    placeholder="Select destination account"
                >
                    <ng-template #item let-account>
                        <div class="flex flex-col text-sm leading-tight py-1 w-full">
                            <div class="font-semibold mb-1 text-center">{{ account.name }}</div>
                            <div class="flex gap-3 text-xs text-gray-600 dark:text-gray-400 justify-center">
                                <span class="flex-shrink-0">Type: <span class="text-gray-900 dark:text-gray-100">{{ getAccountTypeName(account.type) }}</span></span>
                                <span class="flex-shrink-0">Currency: <span class="text-gray-900 dark:text-gray-100">{{ account.currency }}</span></span>
                                <span class="flex-shrink-0">Balance: <span class="font-mono"
                                    [class.text-green-600]="parseFloat(account.currentBalance) > 0"
                                    [class.dark:text-green-400]="parseFloat(account.currentBalance) > 0"
                                    [class.text-red-600]="parseFloat(account.currentBalance) < 0"
                                    [class.dark:text-red-400]="parseFloat(account.currentBalance) < 0">{{ account.currentBalance }}</span></span>
                            </div>
                        </div>
                    </ng-template>
                </p-select>
                @if (destinationAccountId.invalid && (destinationAccountId.dirty || destinationAccountId.touched)) {
                    <p-message severity="error" variant="simple" size="small">Destination Account is required</p-message>
                }
                <div class="flex gap-2">
                    <p-button [disabled]="!canConvert()" severity="info" label="Convert"
                              icon="pi pi-arrow-left"
                              iconPos="left"
                              (onClick)="convertAmount(this.form.get('destinationAmount')!.value, this.form.get('destinationCurrency')!.value,'source')"
                    />
                    <p-inputgroup>
                        <p-inputnumber formControlName="destinationAmount" placeholder="Amount *"
                                       mode="decimal"
                                       [minFractionDigits]="2" [maxFractionDigits]="5"
                        ></p-inputnumber>
                        <p-inputgroup-addon
                            [style]="{'color': 'deepskyblue'}">{{ form.get('destinationCurrency')?.value ?? '' }}
                        </p-inputgroup-addon>
                    </p-inputgroup>
                </div>

                @if (destinationAmount.invalid && (destinationAmount.dirty || destinationAmount.touched)) {
                    <p-message severity="error" variant="simple" size="small">Destination Amount should be > 0</p-message>
                }

            </div>
        </div>
        <div class="flex gap-2">
            <div class="flex flex-col gap-2 w-1/2">
                <div class="flex flex-col gap-2">
                    <label for="accountName">Transaction title *</label>

                    <p-autocomplete formControlName="title" [suggestions]="titleAutoComplete"
                                    (completeMethod)="search($event)"></p-autocomplete>

                    @if (title.invalid && (title.dirty || title.touched)) {
                        <p-message severity="error" variant="simple" size="small">Title is required</p-message>
                    }
                </div>
            </div>
            <div class="flex flex-col gap-2 w-1/2">
                <div class="flex flex-col gap-2">
                    <label>Date *</label>
                    <p-datepicker formControlName="transactionDate" [hourFormat]="'24'"
                                  [showTime]="true"></p-datepicker>
                    @if (transactionDateFm.invalid && (transactionDateFm.dirty || transactionDateFm.touched)) {
                        <p-message severity="error" variant="simple" size="small">Date is required</p-message>
                    }
                </div>
            </div>
        </div>
        <div class="flex gap-2">
            <div class="flex flex-col gap-2 w-1/2">
                <div class="flex flex-col gap-2">
                    <label>Category</label>
                    <p-select [options]="categories" formControlName="categoryId"
                              placeholder="Select Category"
                              optionLabel="name" optionValue="id"
                              filter="true">
                    </p-select>
                </div>
                <div class="flex flex-col gap-2">
                    <label>Tags</label>
                    <p-multiselect [options]="tags" formControlName="tagIds" placeholder="Select Tags"
                                   optionLabel="name" optionValue="id" display="chip"
                                   [maxSelectedLabels]="maxSelectedLabels"
                                   styleClass="w-full"></p-multiselect>
                    <div class="flex gap-2 flex-wrap">
                        @for (tag of form.get('tagIds')!.value; track tag) {
                            @let tagVal = tagById(tag);
                            @if (tagVal) {
                                <p-chip [label]="tagVal.name" [icon]="tagVal.icon" removable="true"
                                        (onRemove)="removeTag(tagVal.id)" />
                            }
                        }
                    </div>
                </div>
            </div>
            <div class="flex flex-col gap-2 w-1/2">
                <div class="flex flex-col gap-2">
                    <label>Notes</label>
                    <textarea rows="5" cols="30" formControlName="notes" pTextarea
                              [autoResize]="true"></textarea>
                </div>
            </div>
        </div>
    </div>
</form>
