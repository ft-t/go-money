@if (visible) {
<div class="spotlight-backdrop fixed inset-0 bg-black/50 z-50 flex items-start justify-center pt-24"
     (click)="onBackdropClick($event)">
    <div class="spotlight-panel bg-surface-0 dark:bg-surface-900 rounded-xl shadow-2xl w-full max-w-lg mx-4 overflow-hidden border border-surface-200 dark:border-surface-700"
         (click)="$event.stopPropagation()">

        <!-- Header with Search -->
        <div class="flex flex-col gap-3 px-4 py-3 border-b border-surface-200 dark:border-surface-700">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2 text-surface-900 dark:text-surface-0">
                    <i class="pi pi-bookmark text-lg"></i>
                    <span class="font-semibold text-lg">Transaction Snippets</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-xs text-surface-500 hidden sm:inline">
                        <kbd class="px-1.5 py-0.5 bg-surface-100 dark:bg-surface-800 rounded text-xs">↑↓</kbd>
                        navigate
                        <kbd class="px-1.5 py-0.5 bg-surface-100 dark:bg-surface-800 rounded text-xs ml-2">Enter</kbd>
                        apply
                    </span>
                    <p-button icon="pi pi-times"
                              severity="secondary"
                              [text]="true"
                              [rounded]="true"
                              (onClick)="close()"></p-button>
                </div>
            </div>
            <!-- Search Input -->
            <p-iconfield iconPosition="left" class="w-full">
                <p-inputicon styleClass="pi pi-search"></p-inputicon>
                <input #searchInput
                       pInputText
                       type="text"
                       [ngModel]="filterText()"
                       (ngModelChange)="onFilterChange($event)"
                       placeholder="Search snippets..."
                       class="w-full"
                       autofocus />
            </p-iconfield>
        </div>

        <!-- Content -->
        <div class="max-h-80 overflow-y-auto">
            @if (filteredSnippets().length === 0) {
                <div class="px-4 py-8 text-center text-surface-600 dark:text-surface-400">
                    @if (filterText()) {
                        <i class="pi pi-search text-4xl mb-3 block"></i>
                        <p>No snippets match "{{ filterText() }}"</p>
                    } @else {
                        <i class="pi pi-inbox text-4xl mb-3 block"></i>
                        <p>No snippets yet</p>
                        <p class="text-sm mt-1">Save your current transactions as a snippet</p>
                    }
                </div>
            } @else {
                <div class="divide-y divide-surface-100 dark:divide-surface-700">
                    @for (snippet of filteredSnippets(); track snippet.id) {
                        <div class="px-4 py-3 transition-colors snippet-item hover:bg-surface-100 dark:hover:bg-surface-800"
                             [attr.draggable]="canDrag()"
                             (dragstart)="onDragStart($event, snippet)"
                             (dragover)="onDragOver($event, snippet)"
                             (dragleave)="onDragLeave()"
                             (dragend)="onDragEnd()"
                             (drop)="onDrop($event, snippet)"
                             [ngClass]="{
                                 'bg-surface-100 dark:bg-surface-800': isSelected(snippet) && !isDragging(snippet),
                                 'opacity-50': isDragging(snippet),
                                 'border-t-2 border-surface-400': isDragOver(snippet)
                             }">
                            <div class="flex items-center justify-between gap-2">
                                <!-- Drag handle + Name -->
                                <div class="flex items-center gap-2 flex-1 min-w-0">
                                    <i class="pi pi-bars text-surface-500 dark:text-surface-400"
                                       [ngClass]="{'cursor-grab': canDrag(), 'cursor-not-allowed opacity-50': !canDrag()}"></i>
                                    @if (editingSnippetId() === snippet.id) {
                                        <input pInputText
                                               type="text"
                                               [ngModel]="editingName()"
                                               (ngModelChange)="editingName.set($event)"
                                               (keydown)="onEditKeydown($event)"
                                               (blur)="saveEditing()"
                                               class="flex-1 text-sm"
                                               autofocus />
                                    } @else {
                                        <div class="flex-1 min-w-0 cursor-pointer group"
                                             (dblclick)="startEditing(snippet.id, snippet.name)"
                                             (click)="onApply(snippet)">
                                            <div class="flex items-center gap-2">
                                                <span class="font-medium truncate text-surface-900 dark:text-surface-100">{{ snippet.name }}</span>
                                                <i class="pi pi-pencil text-xs text-surface-500 dark:text-surface-400 opacity-0 group-hover:opacity-100 transition-opacity"></i>
                                            </div>
                                            <div class="text-xs text-surface-600 dark:text-surface-400 mt-0.5">
                                                {{ getTransactionCount(snippet) }} transaction(s)
                                            </div>
                                        </div>
                                    }
                                </div>
                                <!-- Actions -->
                                <div class="flex items-center gap-1 flex-shrink-0">
                                    <p-button icon="pi pi-play"
                                              pTooltip="Apply snippet"
                                              tooltipPosition="left"
                                              severity="secondary"
                                              [text]="true"
                                              [rounded]="true"
                                              size="small"
                                              (onClick)="onApply(snippet); $event.stopPropagation()"></p-button>
                                    <p-button icon="pi pi-refresh"
                                              pTooltip="Update with current"
                                              tooltipPosition="left"
                                              severity="secondary"
                                              [text]="true"
                                              [rounded]="true"
                                              size="small"
                                              (onClick)="onUpdate(snippet); $event.stopPropagation()"></p-button>
                                    <p-button icon="pi pi-trash"
                                              pTooltip="Delete snippet"
                                              tooltipPosition="left"
                                              severity="secondary"
                                              [text]="true"
                                              [rounded]="true"
                                              size="small"
                                              (onClick)="onDelete(snippet); $event.stopPropagation()"></p-button>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>

        <!-- Footer -->
        <div class="px-4 py-3 border-t border-surface-200 dark:border-surface-700 bg-surface-50 dark:bg-surface-800/50">
            <p-button label="Save Current as Snippet"
                      icon="pi pi-plus"
                      severity="secondary"
                      [fluid]="true"
                      (onClick)="onCreateNew()"></p-button>
        </div>
    </div>
</div>
}

<p-confirmdialog></p-confirmdialog>
